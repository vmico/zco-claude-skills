cmake_minimum_required(VERSION 3.14)
project(ZcoCppProject LANGUAGES CXX)

##; è®¾ç½® C++ æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

##; --- 1. ç¼–è¯‘é€‰é¡¹ä¸å®‰å…¨æ£€æŸ¥ ---

##; é»˜è®¤å¼€å¯å¸¸ç”¨è­¦å‘Š
add_compile_options(-Wall -Wextra -Wpedantic -Wconversion)

##; [å…³é”®] å†…å­˜å®‰å…¨æ£€æŸ¥å¼€å…³ (ä»…åœ¨é Windows ä¸‹æ¨èå¼€å¯ ASan)
option(ENABLE_ASAN "Enable AddressSanitizer for memory safety check" ON)
if(ENABLE_ASAN AND NOT MSVC)
    add_compile_options(-fsanitize=address -fno-omit-frame-pointer)
    add_link_options(-fsanitize=address)
    message(STATUS "âœ… AddressSanitizer enabled")
endif()

##; --- 2. è‡ªåŠ¨åŒ–é›†æˆä¾èµ– (GTest & GBenchmark) ---

include(FetchContent)

##; é›†æˆ Google Test (å« GMock)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/refs/heads/main.zip
)
# For Windows: Prevent overriding the parent project's compiler/linker settings
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

##; --- 3. é¡¹ç›®ç›®æ ‡ (src) ---

##; å»ºè®®å°†æ ¸å¿ƒé€»è¾‘ç¼–è¯‘ä¸ºåº“ï¼Œæ–¹ä¾¿å•å…ƒæµ‹è¯•é“¾æ¥
add_library(project_core
    src/auth/manager.cc
    ##;@TODO: æ·»åŠ æ›´å¤šæºæ–‡ä»¶
)
target_include_directories(project_core PUBLIC src)

##; å¯æ‰§è¡Œæ–‡ä»¶
add_executable(main src/main.cc)
target_link_libraries(main PRIVATE project_core)

##; --- 4. æµ‹è¯•ç›®æ ‡ (tests) ---

enable_testing()

##; å®šä¹‰æµ‹è¯•å¯æ‰§è¡Œæ–‡ä»¶
add_executable(unit_tests
    tests/auth/manager_test.cc
    ##; å¢åŠ æ›´å¤šæµ‹è¯•æ–‡ä»¶...
)

##; é“¾æ¥ GTest å’Œé¡¹ç›®æ ¸å¿ƒåº“
##; GTest::gmock_main ä¼šè‡ªåŠ¨æä¾› main() å…¥å£ï¼Œçœå»æ‰‹åŠ¨å†™æµ‹è¯• main çš„éº»çƒ¦
target_link_libraries(unit_tests
    PRIVATE
        GTest::gtest
        GTest::gmock
        GTest::gmock_main
        project_core
)

##; æ³¨å†Œæµ‹è¯•ä»»åŠ¡åˆ° ctest
include(GoogleTest)
gtest_discover_tests(unit_tests)

##; --- 5. è¦†ç›–ç‡æ”¯æŒ (å¯é€‰) ---

option(ENABLE_COVERAGE "Enable coverage reporting" OFF)
if(ENABLE_COVERAGE)
    add_compile_options(--coverage)
    add_link_options(--coverage)
    message(STATUS "ğŸ“ˆ Coverage reporting enabled")
endif()



########################################################
#####; usage sample 
##:> mkdir build && cd build
##:> cmake .. -DENABLE_ASAN=ON -DENABLE_COVERAGE=ON
##:> make
##:> ctest --output-on-failure  # è¿è¡Œæ‰€æœ‰æµ‹è¯•å¹¶æ˜¾ç¤ºå¤±è´¥è¯¦æƒ…
########################################################
