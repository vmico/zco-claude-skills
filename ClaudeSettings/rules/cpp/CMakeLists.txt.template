# CMake 配置模板
# 现代 CMake (3.15+) 配置示例，包含测试、覆盖率、静态分析等功能
#
# 使用方法:
#   1. 复制此文件到项目根目录: cp CMakeLists.txt.template CMakeLists.txt
#   2. 修改项目名称和版本
#   3. 添加源文件和测试
#   4. 创建 build 目录: mkdir build && cd build
#   5. 配置: cmake ..
#   6. 构建: cmake --build .
#   7. 测试: ctest

cmake_minimum_required(VERSION 3.15)

# -----------------------------------------------------------------------------
# 项目定义
# -----------------------------------------------------------------------------
project(MyProject
    VERSION 1.0.0
    DESCRIPTION "My C++ Project"
    LANGUAGES CXX
)

# -----------------------------------------------------------------------------
# C++ 标准设置
# -----------------------------------------------------------------------------
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# -----------------------------------------------------------------------------
# 编译选项
# -----------------------------------------------------------------------------
# 通用选项
add_compile_options(
    -Wall              # 启用所有常见警告
    -Wextra            # 启用额外警告
    -Wpedantic         # 严格遵循标准
    -Werror            # 将警告视为错误
)

# Debug 模式选项
set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} -g -O0")

# Release 模式选项
set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -O3 -DNDEBUG")

# -----------------------------------------------------------------------------
# 项目目录结构
# -----------------------------------------------------------------------------
set(PROJECT_SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR})
set(PROJECT_BINARY_DIR ${CMAKE_CURRENT_BINARY_DIR})

# 包含目录
include_directories(
    ${PROJECT_SOURCE_DIR}/include
)

# -----------------------------------------------------------------------------
# 源文件
# -----------------------------------------------------------------------------
set(SOURCES
    src/mylib.cpp
    # 添加更多源文件...
)

set(HEADERS
    include/mylib.h
    # 添加更多头文件...
)

# -----------------------------------------------------------------------------
# 库目标
# -----------------------------------------------------------------------------
add_library(${PROJECT_NAME} ${SOURCES} ${HEADERS})

target_include_directories(${PROJECT_NAME}
    PUBLIC
        $<BUILD_INTERFACE:${PROJECT_SOURCE_DIR}/include>
        $<INSTALL_INTERFACE:include>
)

target_compile_features(${PROJECT_NAME} PUBLIC cxx_std_17)

# -----------------------------------------------------------------------------
# 可执行文件（可选）
# -----------------------------------------------------------------------------
add_executable(${PROJECT_NAME}_app src/main.cpp)
target_link_libraries(${PROJECT_NAME}_app PRIVATE ${PROJECT_NAME})

# -----------------------------------------------------------------------------
# 测试
# -----------------------------------------------------------------------------
option(BUILD_TESTING "Build tests" ON)

if(BUILD_TESTING)
    enable_testing()

    # 查找 Google Test
    find_package(GTest QUIET)

    if(NOT GTest_FOUND)
        # 如果系统没有安装，尝试 FetchContent
        include(FetchContent)
        FetchContent_Declare(
            googletest
            GIT_REPOSITORY https://github.com/google/googletest.git
            GIT_TAG        release-1.12.1
        )
        FetchContent_MakeAvailable(googletest)
    endif()

    # 测试可执行文件
    add_executable(${PROJECT_NAME}_test
        test/mylib_test.cpp
        # 添加更多测试文件...
    )

    target_link_libraries(${PROJECT_NAME}_test
        PRIVATE
            ${PROJECT_NAME}
            GTest::gtest_main
    )

    # 自动发现测试
    include(GoogleTest)
    gtest_discover_tests(${PROJECT_NAME}_test)

    # 添加测试到 CTest
    add_test(NAME ${PROJECT_NAME}_test COMMAND ${PROJECT_NAME}_test)
endif()

# -----------------------------------------------------------------------------
# 代码覆盖率（可选）
# -----------------------------------------------------------------------------
option(ENABLE_COVERAGE "Enable code coverage reporting" OFF)

if(ENABLE_COVERAGE AND CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
    message(STATUS "Code coverage enabled")

    # 添加覆盖率编译选项
    target_compile_options(${PROJECT_NAME} PRIVATE --coverage -O0 -g)
    target_link_options(${PROJECT_NAME} PRIVATE --coverage)

    # 覆盖率目标
    find_program(LCOV_PATH lcov)
    find_program(GENHTML_PATH genhtml)

    if(LCOV_PATH AND GENHTML_PATH)
        add_custom_target(coverage
            COMMAND ${LCOV_PATH} --capture --directory . --output-file coverage.info
            COMMAND ${LCOV_PATH} --remove coverage.info '/usr/*' --output-file coverage.info
            COMMAND ${GENHTML_PATH} coverage.info --output-directory coverage_report
            WORKING_DIRECTORY ${CMAKE_BINARY_DIR}
            COMMENT "Generating code coverage report"
        )
    endif()
endif()

# -----------------------------------------------------------------------------
# 静态分析（可选）
# -----------------------------------------------------------------------------
option(ENABLE_CLANG_TIDY "Enable clang-tidy" OFF)

if(ENABLE_CLANG_TIDY)
    find_program(CLANG_TIDY_EXE NAMES clang-tidy)

    if(CLANG_TIDY_EXE)
        message(STATUS "clang-tidy found: ${CLANG_TIDY_EXE}")
        set(CMAKE_CXX_CLANG_TIDY ${CLANG_TIDY_EXE})
    else()
        message(WARNING "clang-tidy not found")
    endif()
endif()

# -----------------------------------------------------------------------------
# 格式化（可选）
# -----------------------------------------------------------------------------
option(ENABLE_CLANG_FORMAT "Enable clang-format" OFF)

if(ENABLE_CLANG_FORMAT)
    find_program(CLANG_FORMAT_EXE NAMES clang-format)

    if(CLANG_FORMAT_EXE)
        message(STATUS "clang-format found: ${CLANG_FORMAT_EXE}")

        # 获取所有源文件
        file(GLOB_RECURSE ALL_SOURCE_FILES
            ${PROJECT_SOURCE_DIR}/src/*.cpp
            ${PROJECT_SOURCE_DIR}/include/*.h
            ${PROJECT_SOURCE_DIR}/test/*.cpp
        )

        add_custom_target(format
            COMMAND ${CLANG_FORMAT_EXE} -i ${ALL_SOURCE_FILES}
            COMMENT "Formatting code with clang-format"
        )

        add_custom_target(format-check
            COMMAND ${CLANG_FORMAT_EXE} --dry-run --Werror ${ALL_SOURCE_FILES}
            COMMENT "Checking code formatting"
        )
    else()
        message(WARNING "clang-format not found")
    endif()
endif()

# -----------------------------------------------------------------------------
# 安装
# -----------------------------------------------------------------------------
include(GNUInstallDirs)

install(TARGETS ${PROJECT_NAME}
    EXPORT ${PROJECT_NAME}Targets
    LIBRARY DESTINATION ${CMAKE_INSTALL_LIBDIR}
    ARCHIVE DESTINATION ${CMAKE_INSTALL_LIBDIR}
    RUNTIME DESTINATION ${CMAKE_INSTALL_BINDIR}
    INCLUDES DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
)

install(DIRECTORY include/
    DESTINATION ${CMAKE_INSTALL_INCLUDEDIR}
)

# -----------------------------------------------------------------------------
# 导出配置
# -----------------------------------------------------------------------------
install(EXPORT ${PROJECT_NAME}Targets
    FILE ${PROJECT_NAME}Targets.cmake
    NAMESPACE ${PROJECT_NAME}::
    DESTINATION ${CMAKE_INSTALL_LIBDIR}/cmake/${PROJECT_NAME}
)

# -----------------------------------------------------------------------------
# 打包
# -----------------------------------------------------------------------------
include(CPack)
set(CPACK_PACKAGE_NAME ${PROJECT_NAME})
set(CPACK_PACKAGE_VERSION ${PROJECT_VERSION})
set(CPACK_PACKAGE_DESCRIPTION_SUMMARY ${PROJECT_DESCRIPTION})

# -----------------------------------------------------------------------------
# 总结
# -----------------------------------------------------------------------------
message(STATUS "")
message(STATUS "Project Configuration:")
message(STATUS "  Name:        ${PROJECT_NAME}")
message(STATUS "  Version:     ${PROJECT_VERSION}")
message(STATUS "  C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "  Build Type:  ${CMAKE_BUILD_TYPE}")
message(STATUS "  Testing:     ${BUILD_TESTING}")
message(STATUS "  Coverage:    ${ENABLE_COVERAGE}")
message(STATUS "  Clang-tidy:  ${ENABLE_CLANG_TIDY}")
message(STATUS "  Clang-format: ${ENABLE_CLANG_FORMAT}")
message(STATUS "")
